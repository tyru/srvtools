#!/usr/bin/env perl
use common::sense;
use Getopt::Long qw(:config gnu_compat no_bundling no_ignore_case);
use Pod::Usage;
use File::Find;
use Data::Dumper;


sub usage () {
    pod2usage(-verbose => 1);
}

sub uneval {
    local $Data::Dumper::Terse = 1;
    local $Data::Dumper::Indent = 1;
    Dumper(@_);
}

{
    my $verbose = 0;

    sub set_verbose {
        $verbose = shift;
    }

    sub verbose {
        $verbose and say STDERR "[verbose] ", @_;
    }
}


my $verbose = 0;
my $follow_symlinks = 0;
my $check_directory = 0;
my $needhelp;
GetOptions(
    'h|help' => \$needhelp,
    'l|follow-symlinks' => \$follow_symlinks,
    'd|directory' => \$check_directory,
    'v|verbose' => \$verbose,
) or usage;
usage if $needhelp;
set_verbose $verbose;


my @dirs = @ARGV ? @ARGV : (".");
@dirs = grep {
    -d || do {
        print STDERR "$_: $!\n";
        0;
    };
} @dirs;
verbose '@dirs = ' . uneval(\@dirs);


find({
    wanted => sub {
        return if !$check_directory && -d $_;
        verbose "processing $_...";
    },
    follow => $follow_symlinks,
    no_chdir => 1,
}, @dirs);


__END__

=head1 NAME

    weavel - unlink and link duplicated files


=head1 SYNOPSIS


=head1 OPTIONS

=over

=item -h, --help

Show this help.

=back


=head1 AUTHOR

tyru <tyru.exe@gmail.com>
